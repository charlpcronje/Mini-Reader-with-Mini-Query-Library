/** 
 * src/fx/utils/IDBManager.js
 * @file IDBManager.js - IndexedDB management utility.
 */

import { ErrorHandler } from './ErrorHandler.js';

/**
 * @class IDBManager
 * @classdesc Manages IndexedDB for storing logs and events.
 */
export class IDBManager {
  /**
   * @private
   * @static
   * @type {IDBDatabase|null}
   */
  static db = null;
  
  /**
   * @method init
   * @description Initializes the IndexedDB database for logging.
   * @param {string} userId - The current user's ID.
   * @return {Promise<void>}
   */
  static async init(userId) {
    try {
      if (this.db) return; // Already initialized

      return new Promise((resolve, reject) => {
        const request = indexedDB.open('componentLogsDB', 1);

        request.onerror = (event) => {
          ErrorHandler.handleError(new Error('IndexedDB open request error'), userId);
          reject(event);
        };

        request.onsuccess = (event) => {
          this.db = event.target.result;
          resolve();
        };

        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('logs')) {
            const store = db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
            store.createIndex('event', 'event', { unique: false });
            store.createIndex('component_slug', 'component_slug', { unique: false });
            store.createIndex('user_id', 'user_id', { unique: false });
            store.createIndex('datetime', 'datetime', { unique: false });
          }
        };
      });
    } catch (error) {
      ErrorHandler.handleError(error, userId);
    }
  }

  /**
   * @method addLog
   * @description Adds a log entry to IndexedDB.
   * @param {Object} logEntry - The log data.
   * @param {string} userId - The current user's ID.
   * @return {Promise<void>}
   */
  static async addLog(logEntry, userId) {
    try {
      if (!this.db) {
        await this.init(userId);
      }
      return new Promise((resolve, reject) => {
        const tx = this.db.transaction('logs', 'readwrite');
        const store = tx.objectStore('logs');
        const request = store.add(logEntry);

        request.onsuccess = () => {
          resolve();
        };
        request.onerror = (event) => {
          ErrorHandler.handleError(new Error('Failed to add log entry to IDB'), userId);
          reject(event);
        };
      });
    } catch (error) {
      ErrorHandler.handleError(error, userId);
    }
  }

  /**
   * @method getAllLogs
   * @description Retrieves all log entries from IndexedDB.
   * @param {string} userId - The current user's ID.
   * @return {Promise<Array<Object>>}
   */
  static async getAllLogs(userId) {
    try {
      if (!this.db) {
        await this.init(userId);
      }
      return new Promise((resolve, reject) => {
        const tx = this.db.transaction('logs', 'readonly');
        const store = tx.objectStore('logs');
        const request = store.getAll();

        request.onsuccess = () => {
          resolve(request.result || []);
        };
        request.onerror = (event) => {
          ErrorHandler.handleError(new Error('Failed to get logs from IDB'), userId);
          reject(event);
        };
      });
    } catch (error) {
      ErrorHandler.handleError(error, userId);
      return [];
    }
  }
}
